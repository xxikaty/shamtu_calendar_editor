<div class="collage-wrap">
  <style>
    .collage-wrap{
      --bg:#f4f0ea;
      --panel:#faf7f1;
      --ring:#e6ddcf;
      --radius:16px;
      --caption-offset: 0px; /* üëà –∑–¥–µ—Å—å —Ä–µ–≥—É–ª–∏—Ä—É–µ—à—å –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä -20px –∏–ª–∏ -60px) */
      max-width:600px;
      margin:20px auto;
      font:14px/1.45 system-ui,Arial;
      color:#2a2a2a;
    }
    .c-card{
      background:var(--panel);
      border:1px solid var(--ring);
      border-radius:var(--radius);
      box-shadow:0 8px 30px rgba(0,0,0,.08);
      padding:18px;
    }
    .c-title{
      text-align:center;
      font:600 16px/1.2 Georgia,serif;
      color:#6f5c33;
      margin-bottom:10px;
    }

    /* === –ø—Ä–µ–≤—å—é –±–ª–æ–∫–∞ === */
    .preview-panel{
      width:580px;
      height:640px;
      margin:0 auto 16px;
      background:url("https://i.imgur.com/KAtXNj4.png") center/cover no-repeat;
      border-radius:16px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:center;
      overflow:hidden;
      position:relative;
      padding-top:52px;
    }
    .c-grid{
      display:grid;
      grid-template-columns:repeat(2,220px);
      grid-template-rows:repeat(2,220px);
      gap:20px;
    }
    .slot{
      width:220px;height:220px;
      border-radius:12px;
      overflow:hidden;
      background:#ddd;
      border:1px solid #e4e0d6;
      box-shadow:0 4px 12px rgba(0,0,0,.08);
    }
    .slot img{
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center;
      display:block;
    }
    .caption{
      position:absolute;
      bottom:calc(30px + var(--caption-offset)); /* üëà —Ä–µ–≥—É–ª–∏—Ä—É–µ–º—ã–π –æ—Ç—Å—Ç—É–ø */
      left:0;right:0;
      text-align:center;
      font-style:italic;
      color:#5a554b;
      background:rgba(255,255,255,.75);
      padding:6px 12px;
      border-radius:10px;
      width:max-content;
      margin:0 auto;
    }

    /* === —Ñ–æ—Ä–º–∞ === */
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .c-controls{display:grid;gap:10px}
    input[type=text]{
      width:100%;padding:8px 10px;
      border:1px solid var(--ring);
      border-radius:10px;
      background:#fff;
    }
    .c-btn{
      appearance:none;
      cursor:pointer;
      border-radius:10px;
      border:1px solid var(--ring);
      background:linear-gradient(180deg,#fff,#f6f1e3);
      padding:10px 12px;
      font-weight:600;
    }
    .c-btn.primary{
      background:linear-gradient(180deg,#c8b07a,#b59f6b);
      color:#fff;
      border-color:#a48e5d;
    }
  </style>

  <div class="c-card preview-panel" id="preview">
    <div class="c-grid">
      <div class="slot"><img id="p1" alt=""></div>
      <div class="slot"><img id="p2" alt=""></div>
      <div class="slot"><img id="p3" alt=""></div>
      <div class="slot"><img id="p4" alt=""></div>
    </div>
    <div class="caption" id="pcap">–ù–∞–¥–ø–∏—Å—å –æ —Ç–æ–º, –∫–∞–∫ —ç—Ç–æ –≤—Å—ë –∫—Ä–∞—Å–∏–≤–æ</div>
  </div>

  <div class="c-card c-controls">
    <div class="c-title">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Å—ã–ª–∫–∏</div>

    <div class="row2">
      <input id="u1" type="text" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ 1">
      <input id="u2" type="text" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ 2">
    </div>
    <div class="row2">
      <input id="u3" type="text" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ 3">
      <input id="u4" type="text" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ 4">
    </div>

    <input id="cap" type="text" placeholder="–í–∞—à–∞ –Ω–∞–¥–ø–∏—Å—å –ø–æ–¥ –∫–æ–ª–ª–∞–∂–µ–º">

    <div class="row2">
      <button id="apply" class="c-btn">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é</button>
      <button id="save" class="c-btn primary">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å PNG</button>
    </div>
  </div>

  <canvas id="cv" style="display:none"></canvas>

  <script>
    const g=id=>document.getElementById(id);
    const inputs=['u1','u2','u3','u4'], pics=['p1','p2','p3','p4'];
    const capIn=g('cap'), capOut=g('pcap');

    // –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
    function updatePreview(){
      pics.forEach((id,i)=>{
        const url=g(inputs[i]).value.trim();
        const img=g(id);
        img.src=url||'';
      });
      capOut.textContent=capIn.value.trim()||'–ù–∞–¥–ø–∏—Å—å –æ —Ç–æ–º, –∫–∞–∫ —ç—Ç–æ –≤—Å—ë –∫—Ä–∞—Å–∏–≤–æ';
    }

    g('apply').addEventListener('click',updatePreview);
    inputs.map(id=>g(id)).forEach(el=>el.addEventListener('input',updatePreview));
    capIn.addEventListener('input',updatePreview);

    function loadImage(url){
      return new Promise((res,rej)=>{
        const img=new Image();
        img.crossOrigin='anonymous';
        img.onload=()=>res(img);
        img.onerror=()=>rej();
        img.src=url;
      });
    }

    function drawRound(ctx,x,y,w,h,r){
      const rr=Math.min(r,w/2,h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr,y);
      ctx.arcTo(x+w,y,x+w,y+h,rr);
      ctx.arcTo(x+w,y+h,x,y+h,rr);
      ctx.arcTo(x,y+h,x,y,rr);
      ctx.arcTo(x,y,x+w,y,rr);
      ctx.closePath();
    }

    async function savePNG(){
      const W=580,H=640,cell=220,gap=20,R=12;
      const PADX=(W-(cell*2+gap))/2, PADY=52;
      const cv=g('cv');cv.width=W;cv.height=H;
      const ctx=cv.getContext('2d');

      // —Ñ–æ–Ω
      const bg=new Image();
      bg.crossOrigin='anonymous';
      bg.src="https://i.imgur.com/KAtXNj4.png";
      await new Promise(r=>{
        bg.onload=r;
        bg.onerror=r;
      });
      ctx.drawImage(bg,0,0,W,H);

      // –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      const imgs=await Promise.all(inputs.map(async id=>{
        const url=g(id).value.trim();
        if(!url)return null;
        try{return await loadImage(url);}catch{return null;}
      }));

      const coords=[
        [PADX,PADY,cell,cell],
        [PADX+cell+gap,PADY,cell,cell],
        [PADX,PADY+cell+gap,cell,cell],
        [PADX+cell+gap,PADY+cell+gap,cell,cell],
      ];

      imgs.forEach((img,i)=>{
        if(!img)return;
        const[x,y,w,h]=coords[i];
        ctx.save();
        drawRound(ctx,x,y,w,h,R);
        ctx.clip();

        const ir=img.width/img.height;
        const ar=w/h;
        let dw,dh,dx,dy;
        if(ir>ar){dh=h;dw=dh*ir;dx=x+(w-dw)/2;dy=y;}
        else{dw=w;dh=dw/ir;dx=x;dy=y+(h-dh)/2;}
        ctx.drawImage(img,dx,dy,dw,dh);
        ctx.restore();
      });

      // –ø–æ–¥–ø–∏—Å—å
      ctx.font='italic 20px Georgia,serif';
      ctx.fillStyle='#5a554b';
      ctx.textAlign='center';
      ctx.fillText(capIn.value.trim(),W/2,H-Number(getComputedStyle(document.querySelector('.collage-wrap')).getPropertyValue('--caption-offset').replace("px",""))-20);

      const url=cv.toDataURL('image/png');
      const a=document.createElement('a');
      a.href=url;
      a.download='collage.png';
      a.click();
    }

    g('save').addEventListener('click',()=>savePNG());
    updatePreview();
  </script>
</div>
