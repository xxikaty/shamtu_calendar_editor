<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Romance: Admin</title>
<style>
:root{
  --bg:#f4f1ea;--panel:#fff;--ring:#ded7c9;--ink:#2b2a29;--muted:#766e5e
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--ink)}
.wrap{max-width:1100px;margin:22px auto;padding:0 16px;display:grid;grid-template-columns:360px 1fr;gap:18px}
.card{background:var(--panel);border:1px solid var(--ring);border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.06);padding:14px}
h2{margin:6px 0 10px}
hr{border:none;height:1px;background:#eadfcd;margin:12px 0}
small{color:var(--muted)}

label{font-size:13px;color:var(--muted)}
input[type="text"],input[type="url"],select{
  width:100%;padding:10px 12px;border:1px solid var(--ring);border-radius:10px;margin-top:6px
}
.row{display:flex;gap:8px}
button{
  appearance:none;cursor:pointer;border-radius:10px;border:1px solid var(--ring);
  background:#fff;padding:10px 12px;font-weight:600
}
button.primary{background:linear-gradient(180deg,#c8b07a,#b59f6b);color:#fff;border-color:#a48e5d}
button.danger{color:#8d4141}
.badge{display:inline-block;font-size:12px;padding:3px 8px;border-radius:999px;background:#f6eed7;border:1px solid var(--ring);margin-left:6px}
.scene-list{display:flex;flex-direction:column;gap:8px;max-height:540px;overflow:auto}
.scene-item{border:1px dashed #e1d7c4;border-radius:10px;padding:10px}
.choice-row{display:flex;gap:8px;margin-top:8px}
.choice-row input{flex:1}
</style>
</head>
<body>
<div class="wrap">

  <!-- Левая колонка — состояния -->
  <div class="card">
    <h2>Сессия</h2>
    <div class="row" style="align-items:center;gap:10px">
      <button id="toggleActive" class="primary">Активна: ?</button>
      <span id="status" class="badge">—</span>
    </div>
    <hr/>
    <h3>Блокировка ходов</h3>
    <div class="row">
      <label style="flex:1">
        Запрет на N ходов
        <input id="lockN" type="number" min="0" step="1" placeholder="например 3"/>
      </label>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="applyLock">Применить</button>
      <button id="decLock">-1 ход</button>
      <button id="resetLock" class="danger">Снять блок</button>
    </div>
    <small id="lockInfo">—</small>

    <hr/>
    <h3>Текущая сцена</h3>
    <div class="row">
      <select id="currentSelect" style="flex:1"></select>
      <button id="setCurrent" class="primary">Перейти</button>
    </div>

  </div>

  <!-- Правая — редактор сцен -->
  <div class="card">
    <h2>Сцены</h2>
    <div class="row">
      <input id="newId" type="text" placeholder="id новой сцены (scene-3)"/>
      <button id="addScene">+ Добавить</button>
    </div>
    <hr/>
    <div id="sceneList" class="scene-list"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script>
/*** 1) КОНФИГ  ***/
const firebaseConfig = {
  apiKey: "PASTE",
  authDomain: "PASTE",
  databaseURL: "PASTE",
  projectId: "PASTE",
  storageBucket: "PASTE",
  messagingSenderId: "PASTE",
  appId: "PASTE"
};
/*** 2) INIT ***/
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/*** DOM ***/
const statusEl = document.getElementById('status');
const toggleActiveBtn = document.getElementById('toggleActive');
const lockNEl = document.getElementById('lockN');
const applyLockBtn = document.getElementById('applyLock');
const decLockBtn = document.getElementById('decLock');
const resetLockBtn = document.getElementById('resetLock');
const lockInfoEl = document.getElementById('lockInfo');

const currentSelect = document.getElementById('currentSelect');
const setCurrentBtn = document.getElementById('setCurrent');

const sceneList = document.getElementById('sceneList');
const addSceneBtn = document.getElementById('addScene');
const newIdEl = document.getElementById('newId');

let scenes = {};
let state = {current:null,active:false,lock:{enabled:false,left:0}};

function renderState(){
  toggleActiveBtn.textContent = state.active ? 'Активна: ДА' : 'Активна: НЕТ';
  statusEl.textContent = `current: ${state.current||'—'}`;
  lockInfoEl.textContent =
    state.lock?.enabled && state.lock.left>0
    ? `Блок включён: осталось ${state.lock.left}`
    : 'Блок отключён';
}

function renderScenes(){
  // селект текущей
  currentSelect.innerHTML='';
  Object.keys(scenes).forEach(id=>{
    const opt = new Option(id,id);
    currentSelect.add(opt);
  });
  currentSelect.value = state.current||'';

  // список карточек
  sceneList.innerHTML='';
  Object.entries(scenes).forEach(([id,sc])=>{
    const box = document.createElement('div');
    box.className='scene-item';

    box.innerHTML = `
      <div class="row" style="align-items:center">
        <strong style="flex:1">${id}</strong>
        <button data-act="del" data-id="${id}" class="danger">Удалить</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label style="flex:1">URL картинки
          <input data-bind="imageUrl" data-id="${id}" type="url" value="${sc.imageUrl||''}">
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <label>Тема: фон
          <input data-bind="theme.bg" data-id="${id}" type="text" value="${(sc.theme&&sc.theme.bg)||'#F5F1EB'}">
        </label>
        <label>Текст кнопки
          <input data-bind="theme.text" data-id="${id}" type="text" value="${(sc.theme&&sc.theme.text)||'#3c3a35'}">
        </label>
        <label>Обводка
          <input data-bind="theme.border" data-id="${id}" type="text" value="${(sc.theme&&sc.theme.border)||'#d9cfc2'}">
        </label>
      </div>

      <hr/>
      <div><strong>Варианты (2–4):</strong></div>
      ${Array.from({length:4}).map((_,i)=>{
        const ch = (sc.choices||[])[i]||{};
        return `
          <div class="choice-row">
            <input data-bind="choices.${i}.text"  data-id="${id}" type="text" placeholder="Текст варианта ${i+1}" value="${ch.text||''}">
            <input data-bind="choices.${i}.next"  data-id="${id}" type="text" placeholder="next scene id" value="${ch.next||''}">
          </div>
        `;
      }).join('')}

      <div class="row" style="margin-top:8px">
        <button data-act="save" data-id="${id}" class="primary">Сохранить сцену</button>
      </div>
    `;
    sceneList.appendChild(box);
  });
}

function collectSceneFromBox(id){
  const q = sel => sceneList.querySelectorAll(`[data-id="${id}"][data-bind="${sel}"]`);
  const val = sel => (q(sel)[0] && q(sel)[0].value.trim()) || '';
  const sc = {
    imageUrl: val('imageUrl'),
    theme: {
      bg:    val('theme.bg')    || '#F5F1EB',
      text:  val('theme.text')  || '#3c3a35',
      border:val('theme.border')|| '#d9cfc2'
    },
    choices:[]
  };
  for(let i=0;i<4;i++){
    const txt = val(`choices.${i}.text`);
    const nxt = val(`choices.${i}.next`);
    if(txt){ sc.choices.push({text:txt,next:nxt}); }
  }
  // гарантируем 2–4
  if(sc.choices.length<2) sc.choices = sc.choices.concat([{text:'—',next:''}]).slice(0,2);
  return sc;
}

/*** Handlers ***/
toggleActiveBtn.addEventListener('click',()=>{
  db.ref('/romance/state/active').set(!state.active);
});

applyLockBtn.addEventListener('click',()=>{
  const n = +lockNEl.value || 0;
  db.ref('/romance/state/lock').set({enabled:n>0, left:n});
});

decLockBtn.addEventListener('click',()=>{
  const left = Math.max( (state.lock?.left||0)-1, 0 );
  const enabled = left>0 ? true : false;
  db.ref('/romance/state/lock').set({enabled, left});
});

resetLockBtn.addEventListener('click',()=>{
  db.ref('/romance/state/lock').set({enabled:false,left:0});
});

setCurrentBtn.addEventListener('click',()=>{
  const id = currentSelect.value;
  if(!id) return;
  db.ref('/romance/state/current').set(id);
  db.ref('/romance/state/updatedAt').set(Date.now());
});

addSceneBtn.addEventListener('click',()=>{
  const id = (newIdEl.value||'').trim();
  if(!id){ alert('Укажи id новой сцены, напр. scene-3'); return; }
  const base = {
    imageUrl:'',
    theme:{bg:'#F5F1EB',text:'#3c3a35',border:'#d9cfc2'},
    choices:[
      {text:'Вариант 1',next:''},
      {text:'Вариант 2',next:''}
    ]
  };
  db.ref('/romance/scenes/'+id).set(base);
  newIdEl.value='';
});

sceneList.addEventListener('click', (e)=>{
  const b = e.target.closest('button'); if(!b) return;
  const id = b.dataset.id;
  if(b.dataset.act==='del'){
    if(confirm('Удалить сцену '+id+'?')) db.ref('/romance/scenes/'+id).remove();
  }
  if(b.dataset.act==='save'){
    const sc = collectSceneFromBox(id);
    db.ref('/romance/scenes/'+id).update(sc);
  }
});

/*** Подписки ***/
db.ref('/romance/state').on('value', snap=>{
  state = Object.assign({current:null,active:false,lock:{enabled:false,left:0}}, snap.val()||{});
  renderState();
  renderScenes();
});

db.ref('/romance/scenes').on('value', snap=>{
  scenes = snap.val()||{};
  renderScenes();
});
</script>
</body>
</html>
