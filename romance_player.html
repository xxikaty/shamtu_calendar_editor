<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Romance: Player</title>
<style>
:root{
  --bg:#F5F1EB;        /* фон карточки */
  --panel:#ffffff;     /* фон внутренней панели */
  --ink:#2b2a29;
  --btnText:#3c3a35;
  --btnBorder:#d9cfc2;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--ink)}
.wrap{max-width:720px;margin:24px auto;padding:0 16px}
.card{background:var(--panel);border:1px solid #e7dfd3;border-radius:18px;box-shadow:0 10px 35px rgba(0,0,0,.06);padding:20px}
.imgbox{border-radius:14px;overflow:hidden;position:relative}
.imgbox img{display:block;width:100%;height:auto;opacity:.98;filter:saturate(.95)}
.badge{position:absolute;top:10px;left:10px;font-size:12px;background:#fff8ef;border:1px solid #eadfcc;border-radius:999px;padding:4px 8px;color:#6c5b3d}

.choices{margin-top:18px;display:flex;flex-direction:column;gap:12px}
.choice{
  appearance:none;cursor:pointer;width:100%;
  background:#f7f3ed;border:1px solid var(--btnBorder);
  color:var(--btnText);font-weight:600;padding:14px 16px;border-radius:12px;
  transition:transform .1s ease,opacity .15s ease,background .15s ease;
}
.choice:hover{transform:translateY(-1px)}
.choice:active{filter:grayscale(.2);opacity:.85}

.state{
  margin:12px 0 0;font-size:13px;color:#8b826e;text-align:center
}
.choice[disabled]{opacity:.5;cursor:not-allowed}

.hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="imgbox">
      <img id="sceneImg" alt="scene"/>
      <div id="badge" class="badge hidden">Пауза</div>
    </div>

    <div id="choices" class="choices"></div>
    <div id="hint" class="state"></div>
  </div>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script>
/*** 1) ВСТАВЬ СВОЙ КОНФИГ ***/
const firebaseConfig = {
  apiKey: "AIzaSyAJu-CECLKqonJxdywNFPDOuoZmvBef6Dc",
  authDomain: "forum-calendar-shamtu.firebaseapp.com",
  databaseURL: "https://forum-calendar-shamtu-default-rtdb.firebaseio.com",
  projectId: "forum-calendar-shamtu",
  storageBucket: "forum-calendar-shamtu.firebasestorage.app",
  messagingSenderId: "705851712133",
  appId: "1:705851712133:web:a9ff4d79e40aad9acc7fec",
  measurementId: "G-SFSTXVF32Y"
};
/*** 2) ИНИТ ***/
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/*** DOM ***/
const imgEl   = document.getElementById('sceneImg');
const badgeEl = document.getElementById('badge');
const choicesEl = document.getElementById('choices');
const hintEl  = document.getElementById('hint');

let cachedScenes = {};
let state = { current:null, active:false, lock:{enabled:false,left:0} };

function applyTheme(theme){
  if(!theme) return;
  document.documentElement.style.setProperty('--bg', theme.bg || '#F5F1EB');
  document.documentElement.style.setProperty('--btnText', theme.text || '#3c3a35');
  document.documentElement.style.setProperty('--btnBorder', theme.border || '#d9cfc2');
}

function renderScene(){
  const sc = cachedScenes[state.current];
  if(!sc){ choicesEl.innerHTML=''; imgEl.src=''; return; }

  imgEl.src = sc.imageUrl || '';
  applyTheme(sc.theme);

  // бейдж
  const paused = !state.active || (state.lock?.enabled && state.lock?.left>0);
  badgeEl.textContent = state.active ? (state.lock?.left>0?'Лок: '+state.lock.left:'') : 'Пауза';
  badgeEl.classList.toggle('hidden', state.active && !(state.lock?.left>0));

  // кнопки
  const disabled = !state.active || (state.lock?.enabled && state.lock?.left>0);
  choicesEl.innerHTML='';
  (sc.choices||[]).forEach((ch,idx)=>{
    if(!ch || !ch.text) return;
    const btn = document.createElement('button');
    btn.className='choice';
    btn.textContent = ch.text;
    btn.disabled = disabled;
    btn.addEventListener('click',()=>{
      if(btn.disabled) return;
      goNext(ch.next);
    });
    choicesEl.appendChild(btn);
  });

  hintEl.textContent = disabled
    ? (!state.active ? 'Действия недоступны: пауза.'
       : `Ходы заблокированы. Ожидайте разрешения (${state.lock.left}).`)
    : '';
}

function goNext(nextId){
  if(!nextId) return;
  // игрок просто просит перейти — меняем только current
  db.ref('/romance/state/current').set(nextId);
  db.ref('/romance/state/updatedAt').set(Date.now());
}

/*** Подписки ***/
db.ref('/romance/scenes').on('value', snap=>{
  cachedScenes = snap.val()||{};
  renderScene();
});

db.ref('/romance/state').on('value', snap=>{
  state = Object.assign({current:null,active:false,lock:{enabled:false,left:0}}, snap.val()||{});
  renderScene();
});
</script>
</body>
</html>

